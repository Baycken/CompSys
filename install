#!/bin/bash
#
# Install the McGill Robotic CompSys package

# Determine ROBOTIC_PATH
export ROBOTIC_PATH=$(dirname ${PWD})

# Colors
header=$(tput setab 1; tput setaf 0)
question=$(tput bold; tput setaf 4)
section=$(tput bold; tput setaf 2)
warning=$(tput bold; tput setaf 1)
reset=$(tput sgr0)

# Header
echo
echo "${header} Welcome to McGill Robotics ${reset}"
echo

# Instructions
cat <<END
Please make sure you have an internet connection and have properly set up your
ssh key on GitHub before proceeding.
END

# Disclaimer
echo
echo "${warning}DISCLAIMER${reset}"
cat DISCLAIMER
echo

# Ask for sudo privileges
sudo -K
sudo echo || exit 1
echo "Please answer the following questions truthfully:"
echo

# Ask if robot
ask="${question}Are you a robot? Probably not.${reset}"
read -p "${ask} [y/N] (default no) " irobot
case "${irobot}" in
  y|Y )
    export IAMROBOT=true
    echo "E: ROBOT NOT YET SUPPORTED"
    exit 1
    ;;
  * )
    echo "Thought so."
    export IAMROBOT=false
    ;;
esac
echo

# Select project
ask="${question}Which project are you working on?${reset}"
echo ${ask}
select project in "AUV" "ROVER"; do
  case "${project}" in
    AUV )
      export ROBOT=auv
      break;;
    ROVER )
      export ROBOT=rover
      break;;
  esac
done
echo "Welcome to ${project}!"

# Ask to install zsh if not installed
if [[ ! ${SHELL} = "/bin/zsh" ]]; then
  echo
  ask="${question}Would you like to switch to zsh? Here be dragons.${reset}"
  read -p "${ask} [y/N] (default no) " zshpls
  case "${zshpls}" in
    y|Y )
      echo "zsh will be installed!"
      echo "You may need to log out and log back in to reflect the changes"
      export INSTALL_ZSH=true
      ;;
    * )
      echo "You're missing out!"
      echo "You can run ./setup/zsh/install if you change your mind"
      export INSTALL_ZSH=false
      ;;
  esac
fi

# Ask to install ROS if not installed
if [[ -z ${ROS_DISTRO} ]]; then
  echo
  ask="${question}Would you like to install ROS? This takes a while.${reset}"
  read -p "${ask} [Y/n] (default yes) " rosplz
  case "${rosplz}" in
    n|N )
      echo "ROS installation will be skipped!"
      echo "Run ./setup/ros/install to install later"
      export INSTALL_ROS=false
      break;;
    * )
      echo "ROS will be installed!"
      export INSTALL_ROS=true
      break;;
  esac
fi

# Inform to wait
echo
echo "Thanks! Now sit back and relax: we'll take care of the rest."
echo

# Update and install packages
echo "${section}Dependencies${reset}"
./update
echo

# Clone repository and setup git hook
echo "${section}Git${reset}"
robot_git=${ROBOTIC_PATH}/${ROBOT}
if [[ ! -d ${robot_git} ]]; then
  echo "Cloning ${robot} git repository..."
  git clone git@github.com:mcgill-robotics/${ROBOT}.git ${robot_git}
fi
./setup/hooks/install
echo

# Install zsh if requested
if [[ ${INSTALL_ZSH} = true ]]; then
  echo "${section}ZSH${reset}"
  ./setup/zsh/install
  echo
fi

# Configure RC files
echo "${section}Configuration files${reset}"
source ${ROBOTIC_PATH}/compsys/setup/config/install
echo

# Install ROS if requested
if [[ ${INSTALL_ROS} = true ]]; then
  echo "${section}ROS${reset}"
  ./setup/ros/install
  echo
fi

# Done
echo "All done!"
echo "You can start playing around in ${ROBOTIC_PATH}/${ROBOT}"
